// src/documentos/documentos.controller.ts
import {
  Controller,
  Post,
  UploadedFiles,
  UseInterceptors,
  Param,
  ParseIntPipe,
  Req,
} from '@nestjs/common';
import { FilesInterceptor } from '@nestjs/platform-express';
import { UploadService } from './upload.service';
import { DocumentosService } from './documentos.service';
import { Get, Query } from '@nestjs/common'; 

@Controller('documentos')
export class DocumentosController {
  constructor(
    private readonly uploadService: UploadService,
    private readonly documentosService: DocumentosService,
  ) {}

  @Post(':idPaciente')
  @UseInterceptors(FilesInterceptor('documentos'))
  async uploadDocumentos(
    @Param('idPaciente', ParseIntPipe) idPaciente: number,
    @UploadedFiles() files: Express.Multer.File[],
    @Req() req,
  ) {
    console.log('üîπ POST recibido para guardar documentos');
    console.log('üîπ Archivos recibidos:', files);
    console.log('üîπ Body recibido:', req);
    const urls = await this.uploadService.uploadFiles(
      files,
      `paciente-${idPaciente}`,
    );

    const tipos = files.map((file) => file.originalname.split('.')[0]);

    // Este ID de usuario puedes ajustar si ya tienes auth; por ahora lo dejamos gen√©rico
    const idUsuario = Number(req.user?.id || 1);
    const esPendiente = req.body.es_pendiente === 'true';

    await this.documentosService.guardarDocumentos(
      idPaciente,
      idUsuario,
      tipos,
      urls,
      esPendiente,
      
    );

    return {
      message: 'Documentos subidos y registrados en DB',
      urls,
     
    };
  }

  /* ---------- NUEVO: CONSULTA ---------- */
  /**
   * GET /documentos?cedula=1098765432      ‚Üí por n√∫mero de documento
   * GET /documentos?msd=MSD-001            ‚Üí por n√∫mero MSD
   * Si env√≠as ambos, se aplica un OR.
   */
  @Get()
  async getDocumentos(
    @Query('cedula') cedula?: string,
    @Query('msd') msd?: string,
  ) {
    if (!cedula && !msd) {
      return { message: 'Debe enviar par√°metro cedula o msd' };
    }
    return this.documentosService.buscarDocumentos({ cedula, msd });
  }

}

